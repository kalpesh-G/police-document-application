<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gujarati Police Document Generator</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Gujarati:wght@400;500;600;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1a5f7a;
            --primary-dark: #0d3b52;
            --secondary: #e3f2fd;
            --accent: #ff9800;
            --light: #f8f9fa;
            --dark: #343a40;
            --border: #dee2e6;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
        }

        body {
            font-family: 'Poppins', 'Noto Sans Gujarati', sans-serif;
            background-color: #f0f2f5;
            color: var(--dark);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            display: flex;
            min-height: 100vh;
            padding: 0;
        }

        .form-panel {
            width: 40%;
            background-color: white;
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid var(--border);
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.05);
        }

        .form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary);
        }

        .form-header h1 {
            color: var(--primary-dark);
            font-size: 1.8rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-header h1 i {
            color: var(--accent);
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            position: sticky;
            top: 0;
            z-index: 100;
            background: white;
            padding: 10px 0;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
            font-family: 'Poppins', sans-serif;
            font-size: 0.9rem;
            flex: 1;
            min-width: 140px;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            background-color: #218838;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .btn-warning {
            background-color: var(--warning);
            color: var(--dark);
        }

        .btn-warning:hover {
            background-color: #e0a800;
        }

        .form-section {
            margin-bottom: 25px;
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            background-color: var(--light);
        }

        .section-header {
            background-color: var(--primary);
            color: white;
            padding: 12px 15px;
            font-weight: 600;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
        }

        .section-header i {
            font-size: 0.9rem;
            transition: transform 0.3s;
        }

        .section-header.collapsed i {
            transform: rotate(-90deg);
        }

        .section-content {
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
        }

        .section-content.collapsed {
            max-height: 0;
            padding: 0 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--primary-dark);
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }

        .form-group label i {
            color: var(--accent);
            font-size: 0.8rem;
        }

        .form-control {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 0.95rem;
            font-family: 'Noto Sans Gujarati', 'Poppins', sans-serif;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 95, 122, 0.1);
        }

        .form-control[type="date"],
        .form-control[type="time"] {
            font-family: 'Poppins', sans-serif;
        }

        select.form-control {
            appearance: auto;
        }

        textarea.form-control {
            resize: vertical;
            min-height: 80px;
        }

        .form-help {
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 3px;
            font-style: italic;
        }

        .preview-panel {
            width: 60%;
            background-color: #f5f5f5;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary);
        }

        .preview-header h2 {
            color: var(--primary-dark);
            font-size: 1.6rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .preview-header h2 i {
            color: var(--accent);
        }

        .preview-container {
            flex: 1;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .preview-document {
            flex: 1;
            padding: 40px;
            font-family: 'Noto Sans Gujarati', serif;
            background-color: white;
            overflow-y: auto;
            line-height: 1.8;
            font-size: 1.05rem;
        }

        .document-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #000;
        }

        .document-header h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            color: #000;
        }

        .document-header .subtitle {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
        }

        .document-section {
            margin-bottom: 25px;
            page-break-inside: avoid;
        }

        .section-title {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 1px solid #ccc;
            color: var(--primary-dark);
        }

        .form-field-row {
            display: flex;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .field-label {
            min-width: 250px;
            font-weight: 600;
            color: #333;
        }

        .field-value {
            flex: 1;
            color: #000;
            padding-left: 10px;
            border-bottom: 1px dotted #aaa;
            min-height: 24px;
        }

        .empty-field {
            color: #999;
            font-style: italic;
        }

        .signature-area {
            margin-top: 50px;
            padding-top: 20px;
            border-top: 1px solid #000;
            text-align: right;
        }

        .signature-line {
            margin-top: 40px;
            border-top: 1px solid #000;
            width: 300px;
            margin-left: auto;
            text-align: center;
            padding-top: 5px;
        }

        .status-message {
            padding: 10px 15px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 0.9rem;
        }

        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 1200px) {
            .container {
                flex-direction: column;
            }
            
            .form-panel, .preview-panel {
                width: 100%;
                height: 50vh;
            }
            
            .form-panel {
                border-right: none;
                border-bottom: 1px solid var(--border);
            }
        }

        @media (max-width: 768px) {
            .section-content {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .preview-document {
                padding: 20px;
                font-size: 0.95rem;
            }
            
            .field-label {
                min-width: 180px;
                font-size: 0.9rem;
            }
            
            .section-title {
                font-size: 1.2rem;
            }
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(0,0,0,.1);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="form-panel">
            <div class="form-header">
                <h1><i class="fas fa-file-alt"></i> ગુજરાત પોલીસ ડૉક્યુમેન્ટ જનરેટર</h1>
                <div class="form-info">
                    <span id="save-status" class="status-message status-success" style="display: none;">ડેટા સેવ થયેલ છે</span>
                </div>
            </div>
            
            <div class="action-buttons">
                <button id="generate-pdf" class="btn btn-primary">
                    <i class="fas fa-file-pdf"></i> PDF જનરેટ કરો
                </button>
                <button id="generate-word" class="btn btn-success">
                    <i class="fas fa-file-word"></i> Word જનરેટ કરો
                </button>
                <button id="print-preview" class="btn btn-warning">
                    <i class="fas fa-print"></i> પ્રિન્ટ
                </button>
                <button id="clear-form" class="btn btn-danger">
                    <i class="fas fa-trash-alt"></i> ફોર્મ સાફ કરો
                </button>
            </div>
            
            <form id="police-form">
                <div class="form-section">
                    <div class="section-header" data-section="accused">
                        <span><i class="fas fa-user"></i> આરોપીની વિગતો (Accused Details)</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="section-content">
                        <div class="form-group">
                            <label for="acc_name"><i class="fas fa-signature"></i> આરોપીનું નામ (Accused Name):</label>
                            <input type="text" id="acc_name" name="acc_name" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="acc_caste"><i class="fas fa-users"></i> જાતિ (Caste):</label>
                            <input type="text" id="acc_caste" name="acc_caste" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="acc_age"><i class="fas fa-birthday-cake"></i> ઉંમર (Age):</label>
                            <input type="number" id="acc_age" name="acc_age" class="form-control">
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="section-header" data-section="occupation">
                        <span><i class="fas fa-briefcase"></i> વ્યવસાય (Occupation)</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="section-content">
                        <div class="form-group">
                            <label for="occ_type"><i class="fas fa-user-tie"></i> ધંધો (Occupation Type):</label>
                            <input type="text" id="occ_type" name="occ_type" class="form-control">
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="section-header" data-section="perm-address">
                        <span><i class="fas fa-home"></i> કાયમી સરનામું (Permanent Address)</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="section-content">
                        <div class="form-group">
                            <label for="perm_village"><i class="fas fa-village"></i> ગામ (Village):</label>
                            <input type="text" id="perm_village" name="perm_village" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="perm_district"><i class="fas fa-map-marked-alt"></i> જીલ્લો (District):</label>
                            <select id="perm_district" name="perm_district" class="form-control">
                                <option value="">પસંદ કરો</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="perm_taluka"><i class="fas fa-map"></i> તાલુકો (Taluka):</label>
                            <select id="perm_taluka" name="perm_taluka" class="form-control">
                                <option value="">પહેલા જિલ્લો પસંદ કરો</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="section-header" data-section="police-station">
                        <span><i class="fas fa-shield-alt"></i> પોલીસ સ્ટેશન (Police Station)</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="section-content">
                        <div class="form-group">
                            <label for="case_ps"><i class="fas fa-shield-alt"></i> પોલીસ સ્ટેશન નું નામ (Police Station Name):</label>
                            <input type="text" id="case_ps" name="case_ps" class="form-control">
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="section-header" data-section="case-details">
                        <span><i class="fas fa-gavel"></i> ગુનાની વિગતો (Case Details)</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="section-content">
                        <div class="form-group">
                            <label for="crime_no"><i class="fas fa-hashtag"></i> ગુ.ર.નં / FIR નંબર (FIR Number):</label>
                            <input type="text" id="crime_no" name="crime_no" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="offence_sections"><i class="fas fa-balance-scale"></i> કલમો (Offence Sections):</label>
                            <textarea id="offence_sections" name="offence_sections" class="form-control" rows="2" placeholder="દા.ત.: પ્રોહિ એક્ટ કલમ-૬૫"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="arrest_date"><i class="fas fa-calendar-day"></i> અટકાયતની તારીખ (Arrest Date):</label>
                            <input type="date" id="arrest_date" name="arrest_date" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="arrest_time"><i class="fas fa-clock"></i> અટકાયતનો સમય (Arrest Time):</label>
                            <input type="time" id="arrest_time" name="arrest_time" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="arrest_place"><i class="fas fa-map-marker-alt"></i> અટકાયતનું સ્થળ (Arrest Place):</label>
                            <input type="text" id="arrest_place" name="arrest_place" class="form-control">
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="section-header" data-section="relative">
                        <span><i class="fas fa-users"></i> સગા/સંબંધી વિગતો (Relative Information)</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="section-content">
                        <div class="form-group">
                            <label for="rel_name"><i class="fas fa-user"></i> સગા/સંબંધીનું નામ (Relative Name):</label>
                            <input type="text" id="rel_name" name="rel_name" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="rel_address"><i class="fas fa-address-card"></i> સગા/સંબંધીનું સરનામું (Relative Address):</label>
                            <textarea id="rel_address" name="rel_address" class="form-control" rows="2"></textarea>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="section-header" data-section="officer">
                        <span><i class="fas fa-user-shield"></i> અધિકારી વિગતો (Officer Details)</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="section-content">
                        <div class="form-group">
                            <label for="io_name"><i class="fas fa-user-check"></i> અમલદારનું નામ (IO Name):</label>
                            <input type="text" id="io_name" name="io_name" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="io_designation"><i class="fas fa-id-badge"></i> હોદ્દો (Designation):</label>
                            <input type="text" id="io_designation" name="io_designation" class="form-control" placeholder="દા.ત.: એ.કે.કોન્સ્ટ.">
                        </div>
                        <div class="form-group">
                            <label for="io_buckle"><i class="fas fa-id-badge-alt"></i> બકલ નંબર (Buckle No.):</label>
                            <input type="text" id="io_buckle" name="io_buckle" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="auth_date"><i class="fas fa-calendar-check"></i> દસ્તાવેજ તારીખ (Document Date):</label>
                            <input type="date" id="auth_date" name="auth_date" class="form-control">
                        </div>
                    </div>
                </div>
            </form>
        </div>
        
        <div class="preview-panel">
            <div class="preview-header">
                <h2><i class="fas fa-eye"></i> ડૉક્યુમેન્ટ પ્રિવ્યુ (Document Preview)</h2>
                <div class="preview-info">
                    <span id="preview-status" class="status-message" style="display: none;"></span>
                </div>
            </div>
            
            <div class="preview-container">
                <div class="preview-document" id="document-preview">
                    </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docx@7.8.0/build/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script src="gujarat-district-taluka-gu.js"></script>
    
    <script>
        // Use districts data from external file
        const districtsData = gujaratTalukas;

        // Form state
        let formData = {};

        // DOM elements
        const form = document.getElementById('police-form');
        const preview = document.getElementById('document-preview');
        const saveStatus = document.getElementById('save-status');
        const previewStatus = document.getElementById('preview-status');

        // All form fields as per your data structure
        const allFields = [
            // Accused Details
            'acc_name', 'acc_caste', 'acc_age',
            
            // Occupation
            'occ_type',
            
            // Permanent Address
            'perm_village', 'perm_taluka', 'perm_district',
            
            // Police Station
            'case_ps',
            
            // Case Details
            'crime_no', 'offence_sections', 'arrest_date', 'arrest_time', 'arrest_place',
            
            // Relative/Intimation
            'rel_name', 'rel_address',
            
            // Officer
            'io_name', 'io_designation', 'io_buckle', 'auth_date'
        ];

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // 1. Populate districts options first (Important for value setting)
            populateDistricts();

            // 2. Setup listeners and collapsible sections
            setupEventListeners();
            setupCollapsibleSections();

            // 3. Load Saved Data (This now calls updateTalukaDropdowns and updatePreview)
            loadSavedData();
        });

        // Load data from localStorage - UPDATED LOGIC
        function loadSavedData() {
            const savedData = localStorage.getItem('policeFormData');
            
            if (savedData) {
                try {
                    const parsedData = JSON.parse(savedData);
                    formData = parsedData; // Update global state object
                    
                    console.log('Loaded data from localStorage:', formData);
                    
                    // Iterate over keys and set input values
                    allFields.forEach(fieldName => {
                        const element = document.querySelector(`[name="${fieldName}"]`);
                        if (element && formData[fieldName] !== undefined) {
                            element.value = formData[fieldName];
                        }
                    });

                    // Special Handling for District/Taluka
                    // 1. Trigger district change to populate Talukas
                    if (formData.perm_district) {
                        const districtSelect = document.getElementById('perm_district');
                        if (districtSelect) {
                            districtSelect.value = formData.perm_district;
                            updateTalukaDropdowns(); // Populate taluka options based on district
                        }
                    }

                    // 2. Set Taluka value now that options exist
                    if (formData.perm_taluka) {
                        const talukaSelect = document.getElementById('perm_taluka');
                        if (talukaSelect) {
                            talukaSelect.value = formData.perm_taluka;
                        }
                    }
                    
                    // Refresh preview with loaded data
                    updatePreview();
                    
                    // Show success message
                    showStatus('સંગ્રહિત ડેટા સફળતાપૂર્વક લોડ થયો (Saved Data Loaded)', 'success', saveStatus);
                } catch (e) {
                    console.error('Error loading saved data:', e);
                    showStatus('ડેટા લોડ કરવામાં ભૂલ (Error Loading Data)', 'error', saveStatus);
                }
            } else {
                console.log('No saved data found in localStorage');
                showStatus('કોઈ સેવ કરેલો ડેટા મળ્યો નથી (No Saved Data Found)', 'error', saveStatus);
            }
        }

        // Save data to localStorage
        function saveFormData() {
            try {
                // Collect all form data
                const formElements = form.elements;
                const newData = {};
                
                for (const element of formElements) {
                    if (element.name && element.name.trim() !== '') {
                        newData[element.name] = element.value;
                    }
                }
                
                // Also check for any missing fields that might not be in the form but in our structure
                allFields.forEach(fieldName => {
                    if (!(fieldName in newData)) {
                        newData[fieldName] = formData[fieldName] || '';
                    }
                });
                
                // Merge with existing data
                formData = { ...formData, ...newData };
                
                // Save to localStorage
                localStorage.setItem('policeFormData', JSON.stringify(formData));
                
                // Auto-save indicator
                const now = new Date();
                const timeStr = now.toLocaleTimeString('gu-IN', { hour: '2-digit', minute: '2-digit' });
                showStatus(`સેવ થયેલ (${timeStr})`, 'success', saveStatus);
            } catch (e) {
                console.error('Error saving data:', e);
                showStatus('સેવ કરવામાં ભૂલ', 'error', saveStatus);
            }
        }

        // Populate district dropdowns
        function populateDistricts() {
            const districtSelects = [
                document.getElementById('perm_district')
            ].filter(el => el);
            
            districtSelects.forEach(select => {
                // Clear existing options except the first
                while (select.options.length > 1) {
                    select.remove(1);
                }
                
                // Add districts
                districtsData.districts.forEach(district => {
                    const option = document.createElement('option');
                    option.value = district.district;
                    option.textContent = `${district.name_en} (${district.district})`;
                    select.appendChild(option);
                });
            });
        }

        // Update taluka dropdowns based on selected district
        function updateTalukaDropdowns() {
            const districtTalukaPairs = [
                { district: 'perm_district', taluka: 'perm_taluka' }
            ];
            
            districtTalukaPairs.forEach(pair => {
                const districtSelect = document.getElementById(pair.district);
                const talukaSelect = document.getElementById(pair.taluka);
                
                if (districtSelect && talukaSelect) {
                    const selectedDistrict = districtSelect.value;
                    
                    // Clear existing options except the first
                    while (talukaSelect.options.length > 1) {
                        talukaSelect.remove(1);
                    }
                    
                    if (selectedDistrict) {
                        // Find selected district
                        const districtObj = districtsData.districts.find(
                            d => d.district === selectedDistrict
                        );
                        
                        if (districtObj) {
                            // Add talukas
                            districtObj.talukas.forEach(taluka => {
                                const option = document.createElement('option');
                                option.value = taluka;
                                option.textContent = taluka;
                                talukaSelect.appendChild(option);
                            });
                            
                            // Set saved value if exists (handled in loadSavedData too, but kept here for dynamic changes)
                            if (formData[pair.taluka]) {
                                talukaSelect.value = formData[pair.taluka];
                            }
                        }
                    }
                }
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            // Form input events - auto-save and update preview
            form.addEventListener('input', function(e) {
                if (e.target.name) {
                    saveFormData();
                    updatePreview();
                }
            });
            
            form.addEventListener('change', function(e) {
                if (e.target.name) {
                    // If district changed, update taluka dropdown
                    if (e.target.name.includes('district')) {
                        updateTalukaDropdowns();
                    }
                    
                    saveFormData();
                    updatePreview();
                }
            });
            
            // District change events
            const districtSelects = ['perm_district'];
            districtSelects.forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    select.addEventListener('change', updateTalukaDropdowns);
                }
            });
            
            // Button events
            document.getElementById('generate-pdf').addEventListener('click', generatePDF);
            document.getElementById('generate-word').addEventListener('click', generateWord);
            document.getElementById('clear-form').addEventListener('click', clearForm);
            document.getElementById('print-preview').addEventListener('click', printPreview);
        }

        // Setup collapsible sections
        function setupCollapsibleSections() {
            const sectionHeaders = document.querySelectorAll('.section-header');
            sectionHeaders.forEach(header => {
                header.addEventListener('click', function() {
                    const sectionContent = this.nextElementSibling;
                    this.classList.toggle('collapsed');
                    sectionContent.classList.toggle('collapsed');
                    
                    const icon = this.querySelector('i.fa-chevron-down');
                    if (icon) {
                        icon.style.transform = this.classList.contains('collapsed') ? 'rotate(-90deg)' : 'rotate(0)';
                    }
                });
            });
        }

        // Update the preview
        function updatePreview() {
            try {
                // Get all form values
                const formValues = {};
                allFields.forEach(fieldName => {
                    const element = document.querySelector(`[name="${fieldName}"]`);
                    formValues[fieldName] = element ? element.value : (formData[fieldName] || '');
                });
                
                // Generate preview HTML
                preview.innerHTML = generateDocumentHTML(formValues);
            } catch (e) {
                console.error('Error updating preview:', e);
                preview.innerHTML = '<div style="color: red; padding: 20px;">પ્રિવ્યુ જનરેટ કરવામાં ભૂલ</div>';
            }
        }

        // Generate document HTML for preview (Atkayat Memo format)
        function generateDocumentHTML(data) {
            // Format date to Gujarati style (dd/mm/yyyy)
            const formatDate = (dateString) => {
                if (!dateString) return '................';
                try {
                    const date = new Date(dateString);
                    if (isNaN(date.getTime())) return dateString;
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = date.getFullYear();
                    return `${day}/${month}/${year}`;
                } catch {
                    return dateString;
                }
            };

            // Build accused address components
            const accusedAddress = data.perm_village || '................................................................';
            const accusedTaluka = data.perm_taluka || '................................................................';
            const accusedDistrict = data.perm_district || '................................................................';

            // Accused line components
            const accusedName = data.acc_name || '................................................................';
            const accusedCaste = data.acc_caste || '...........................';
            const accusedAge = data.acc_age || '....';
            const accusedOccupation = data.occ_type || '................';

            // Officer details
            const ioName = data.io_name || '................................................................';
            const ioDesignation = data.io_designation || '.......................';
            const ioBuckleNumber = data.io_buckle || '..............';
            const policeStationName = data.case_ps || '................................................................';

            // Case details
            const firNumber = data.crime_no || '.................................................................';
            const actSection = data.offence_sections || '.................................................................';

            // Arrest details
            const arrestDate = formatDate(data.arrest_date);
            const arrestTime = data.arrest_time || '.........';
            const arrestPlace = data.arrest_place || '........................';

            // Relative details
            const relativeName = data.rel_name || '..................................................................';
            const relativeAddress = data.rel_address || '................................................................';
            const notificationDate = formatDate(data.auth_date);

            return `
    <div style="font-family: 'Noto Sans Gujarati', serif; padding: 40px; line-height: 1.8; font-size: 1.05rem; color: #000;">
        
        <div style="text-align: center; margin-bottom: 25px;">
            <h1 style="font-size: 1.8rem; font-weight: bold; margin: 0; text-decoration: underline;">અટકાયત મેમો</h1>
        </div>

        <div style="margin-bottom: 15px; line-height: 1.9;">
            <p style="margin: 0;">
                હું <span style="min-width: 250px; display: inline-block; padding: 0 5px; font-weight: bold;">${accusedName}</span> 
                જાતે.<span style="min-width: 150px; display: inline-block; padding: 0 5px;">${accusedCaste}</span> 
                ઉ.વ <span style="min-width: 50px; display: inline-block; padding: 0 5px;">${accusedAge}</span> 
                ધંધો <span style="min-width: 120px; display: inline-block; padding: 0 5px;">${accusedOccupation}</span> 
                રહે-<span style="min-width: 200px; display: inline-block; padding: 0 5px;">${accusedAddress}</span>
            </p>
            <p style="margin: 5px 0 0 0;">
                તા-<span style="min-width: 150px; display: inline-block; padding: 0 5px;">${accusedTaluka}</span> 
                જી.<span style="min-width: 150px; display: inline-block; padding: 0 5px;">${accusedDistrict}</span>
            </p>
        </div>

        <div style="margin-bottom: 15px; margin-top: 20px; line-height: 1.9;">
            <p style="margin: 0;">
                હું <span style="min-width: 250px; display: inline-block; padding: 0 5px; font-weight: bold;">${ioName}</span> 
                <span style="min-width: 150px; display: inline-block; padding: 0 5px;">${ioDesignation}</span> 
                બ.નં.<span style="min-width: 80px; display: inline-block; padding: 0 5px;">${ioBuckleNumber}</span> 
                <span style="min-width: 200px; display: inline-block; padding: 0 5px;">${policeStationName}</span> પો.સ્ટે.
            </p>
        </div>

        <div style="margin-top: 15px; text-align: justify; line-height: 2.0;">
            <p style="margin: 0; text-indent: 3em;">
                આથી તમારા ઉપર <span style="min-width: 200px; display: inline-block; padding: 0 5px; font-weight: bold;">${policeStationName}</span> 
                પો.સ્ટે.પાર્ટ બી ગુ.ર.નં.<span style="min-width: 220px; display: inline-block; padding: 0 5px; font-weight: bold;">${firNumber}</span> 
                <span style="min-width: 220px; display: inline-block; padding: 0 5px;">${actSection}</span>,
                મુજબના ગુનાના કામે હું તમોને આજરોજ તા.<span style="min-width: 110px; display: inline-block; padding: 0 5px; font-weight: bold;">${arrestDate}</span> 
                ના કલાક-<span style="min-width: 80px; display: inline-block; padding: 0 5px; font-weight: bold;">${arrestTime}</span> 
                વાગે <span style="min-width: 150px; display: inline-block; padding: 0 5px;">${arrestPlace}</span> 
                મુકામે આ ગુનાના કામે અટક કરૂ છું. હાલમાં જોતા તમારા શરીરે કોઇ મારઝુડના કે બીજા કોઇ ઇજાના ચિન્હો જણાતા નથી. આ બાબતની જાણ તમારા સંબંધી 
                <span style="min-width: 250px; display: inline-block; padding: 0 5px;">${relativeName}</span>
                તા.<span style="min-width: 150px; display: inline-block; padding: 0 5px;">${relativeAddress}</span> 
                વાળાઓને રૂબરૂમાં જાણ કરવામાં આવેલ છે .તા.<span style="min-width: 110px; display: inline-block; padding: 0 5px;">${notificationDate}</span>.
            </p>
        </div>

        <div style="margin-top: 40px; line-height: 2.2;">
            <p style="margin: 0;">
                આરોપીની સહી- <span style="border-bottom: 1px dashed #000; display: inline-block; width: 300px; margin-left: 5px;"></span>
            </p>
            <p style="margin: 15px 0 0 0;">
                આરોપીના સગા/સબંધીની સહી. – <span style="border-bottom: 1px dashed #000; display: inline-block; width: 250px; margin-left: 5px;"></span>
            </p>
        </div>

        <div style="margin-top: 50px; text-align: right; line-height: 1.6;">
            <div style="display: inline-block; text-align: center; min-width: 200px;">
                <p style="margin: 5px 0; font-weight: bold;">( ${ioName} )</p>
                <p style="margin: 5px 0;">${ioDesignation} બ.નં.${ioBuckleNumber}</p>
                <p style="margin: 5px 0;">${policeStationName} પોલીસ સ્ટેશન</p>
            </div>
        </div>
    </div>
`;
        }

        // Generate PDF document
        async function generatePDF() {
            try {
                const button = document.getElementById('generate-pdf');
                const originalText = button.innerHTML;
                button.innerHTML = '<span class="loading"></span> PDF જનરેટ થાય છે...';
                button.disabled = true;
                
                // Use html2canvas to capture the preview
                const canvas = await html2canvas(preview, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff'
                });
                
                // Create PDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });
                
                // Define official margins (all sides) in mm
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const margin = 20; // 20mm margin on all sides

                const availableWidth = pdfWidth - margin * 2;
                const availableHeight = pdfHeight - margin * 2;

                // Scale factor to fit width within margins
                const ratio = availableWidth / canvas.width;
                const targetWidth = canvas.width * ratio; // should be equal to availableWidth
                const fullImageHeight = canvas.height * ratio; // height in mm if drawn in one page

                if (fullImageHeight <= availableHeight) {
                    // Single-page: center content within margins
                    const x = margin;
                    const y = margin;
                    const imgData = canvas.toDataURL('image/png');
                    pdf.addImage(imgData, 'PNG', x, y, targetWidth, fullImageHeight);
                } else {
                    // Multi-page: slice the canvas vertically into page-sized chunks
                    const sliceHeightPx = Math.floor(availableHeight / ratio); // slice height in source pixels per page
                    let offsetPx = 0;
                    let pageIndex = 0;

                    while (offsetPx < canvas.height) {
                        const remainingPx = canvas.height - offsetPx;
                        const currentSlicePx = Math.min(sliceHeightPx, remainingPx);

                        // Create a temporary canvas for the slice
                        const tempCanvas = document.createElement('canvas');
                        tempCanvas.width = canvas.width;
                        tempCanvas.height = currentSlicePx;
                        const tempCtx = tempCanvas.getContext('2d');

                        // Draw the slice from the full canvas into the temp canvas
                        tempCtx.drawImage(
                            canvas,
                            0, offsetPx, canvas.width, currentSlicePx,
                            0, 0, canvas.width, currentSlicePx
                        );

                        // Convert slice to image and add to PDF
                        const sliceImgData = tempCanvas.toDataURL('image/png');
                        const sliceHeightMm = currentSlicePx * ratio;

                        if (pageIndex > 0) {
                            pdf.addPage();
                        }
                        pdf.addImage(sliceImgData, 'PNG', margin, margin, targetWidth, sliceHeightMm);

                        // Advance offset
                        offsetPx += currentSlicePx;
                        pageIndex += 1;
                    }
                }

                pdf.save('gujarat_police_document.pdf');
                
                showStatus('PDF ડાઉનલોડ થઈ ગયું છે', 'success', previewStatus);
            } catch (error) {
                console.error('PDF generation error:', error);
                showStatus('PDF જનરેટ કરવામાં ભૂલ', 'error', previewStatus);
            } finally {
                const button = document.getElementById('generate-pdf');
                button.innerHTML = '<i class="fas fa-file-pdf"></i> PDF જનરેટ કરો';
                button.disabled = false;
            }
        }

        // Generate Word document
        async function generateWord() {
            try {
                const button = document.getElementById('generate-word');
                button.innerHTML = '<span class="loading"></span> Word જનરેટ થાય છે...';
                button.disabled = true;
                
                // Get form data for Word
                const formValues = {};
                allFields.forEach(fieldName => {
                    const element = document.querySelector(`[name="${fieldName}"]`);
                    formValues[fieldName] = element ? element.value : (formData[fieldName] || '');
                });

                // Ensure docx library is available
                const docxLib = window.docx;
                if (!docxLib || !docxLib.Document) {
                    throw new Error('docx library not loaded');
                }

                const { Document, Paragraph, TextRun, AlignmentType, Packer, UnderlineType } = docxLib;

                // Helpers
                const mmToTwip = (mm) => Math.round((mm / 25.4) * 1440);
                const marginTwip = mmToTwip(25.4); // 2.54 cm margins
                const makeRun = (text, opts = {}) => new TextRun({
                    text: text || '',
                    font: 'Noto Sans Gujarati',
                    size: 24, // ~12pt
                    ...opts,
                });

                // Extract fields
                const accusedName = formValues.acc_name || '';
                const accusedCaste = formValues.acc_caste || '';
                const accusedAge = formValues.acc_age || '';
                const accusedOccupation = formValues.occ_type || '';
                const accusedAddress = formValues.perm_village || '';
                const accusedTaluka = formValues.perm_taluka || '';
                const accusedDistrict = formValues.perm_district || '';

                const ioName = formValues.io_name || '';
                const ioDesignation = formValues.io_designation || '';
                const ioBuckleNumber = formValues.io_buckle || '';
                const policeStationName = formValues.case_ps || '';

                const firNumber = formValues.crime_no || '';
                const actSection = formValues.offence_sections || '';

                const arrestDate = formValues.arrest_date || '';
                const arrestTime = formValues.arrest_time || '';
                const arrestPlace = formValues.arrest_place || '';

                const relativeName = formValues.rel_name || '';
                const relativeAddress = formValues.rel_address || '';
                const notificationDate = formValues.auth_date || '';

                // Build DOCX document
                const doc = new Document({
                    sections: [
                        {
                            properties: {
                                // A4 page with larger margins similar to preview image
                                page: {
                                    size: { width: mmToTwip(210), height: mmToTwip(297), orientation: 'portrait' },
                                    margin: { top: marginTwip, right: marginTwip, bottom: marginTwip, left: marginTwip },
                                },
                            },
                            children: [
                                // Title
                                new Paragraph({
                                    alignment: AlignmentType.CENTER,
                                    spacing: { after: 240 },
                                    children: [makeRun('અટકાયત મેમો', { bold: true, size: 28 })],
                                }),

                                // Accused details line 1
                                new Paragraph({
                                    spacing: { after: 240 },
                                    children: [
                                        makeRun('હું '),
                                        makeRun(accusedName, { bold: true }),
                                        makeRun(' જાતે.'),
                                        makeRun(accusedCaste),
                                        makeRun(' ઉ.વ '),
                                        makeRun(accusedAge),
                                        makeRun(' ધંધો '),
                                        makeRun(accusedOccupation),
                                        makeRun(' રહે-'),
                                        makeRun(accusedAddress),
                                    ],
                                }),
                                // Accused details line 2
                                new Paragraph({
                                    spacing: { after: 240 },
                                    children: [
                                        makeRun('તા-'),
                                        makeRun(accusedTaluka),
                                        makeRun(' જી.'),
                                        makeRun(accusedDistrict),
                                    ],
                                }),

                                // Officer line
                                new Paragraph({
                                    spacing: { after: 240 },
                                    children: [
                                        makeRun('હું '),
                                        makeRun(ioName, { bold: true }),
                                        makeRun(' '),
                                        makeRun(ioDesignation),
                                        makeRun(' બ.નં.'),
                                        makeRun(ioBuckleNumber),
                                        makeRun(' '),
                                        makeRun(policeStationName),
                                        makeRun(' પો.સ્ટે.'),
                                    ],
                                }),

                                // Main memo paragraph
                                new Paragraph({
                                    indent: { firstLine: mmToTwip(10) },
                                    spacing: { after: 240 },
                                    children: [
                                        makeRun('આથી તમારા ઉપર '),
                                        makeRun(policeStationName, { bold: true }),
                                        makeRun(' પો.સ્ટે.પાર્ટ બી ગુ.ર.નં.'),
                                        makeRun(firNumber, { bold: true }),
                                        makeRun(' '),
                                        makeRun(actSection),
                                        makeRun(' મુજબના ગુનાના કામે હું તમોને આજરોજ તા.'),
                                        makeRun(arrestDate, { bold: true }),
                                        makeRun(' ના કલાક-'),
                                        makeRun(arrestTime, { bold: true }),
                                        makeRun(' વાગે '),
                                        makeRun(arrestPlace),
                                        makeRun(' મુકામે આ ગુનાના કામે અટક કરૂ છું. હાલમાં જોતા તમારા શરીરે કોઇ મારઝુડના કે બીજા કોઇ ઇજાના ચિન્હો જણાતા નથી. આ બાબતની જાણ તમારા સંબંધી '),
                                        makeRun(relativeName),
                                        makeRun(' ....................................................................... '),
                                        makeRun('તા.'),
                                        makeRun(relativeAddress),
                                        makeRun(' વાળાઓને રૂબરૂમાં જાણ કરવામાં આવેલ છે .તા.'),
                                        makeRun(notificationDate),
                                        makeRun('.'),
                                    ],
                                }),

                                // Signatures
                                new Paragraph({ spacing: { after: 240 }, children: [ makeRun('આરોપીની સહી- _______________________________________________') ] }),
                                new Paragraph({ spacing: { after: 240 }, children: [ makeRun('આરોપીના સગા/સબંધીની સહી. – ________________________________') ] }),

                                // Officer signature block (right aligned)
                                new Paragraph({ alignment: AlignmentType.RIGHT, spacing: { after: 240 }, children: [ makeRun('( ' + ioName + ' )', { bold: true }) ] }),
                                new Paragraph({ alignment: AlignmentType.RIGHT, spacing: { after: 240 }, children: [ makeRun(ioDesignation + ' બ.નં.' + ioBuckleNumber) ] }),
                                new Paragraph({ alignment: AlignmentType.RIGHT, spacing: { after: 240 }, children: [ makeRun(policeStationName + ' પોલીસ સ્ટેશન') ] }),
                            ],
                        },
                    ],
                });

                // File name using FIR if available
                const filename = (firNumber ? `atkayat_memo_${firNumber}.docx` : 'gujarat_police_document.docx');

                const blob = await Packer.toBlob(doc);
                saveAs(blob, filename);
                
                showStatus('ડૉક્યુમેન્ટ ડાઉનલોડ થઈ ગયું છે', 'success', previewStatus);
            } catch (error) {
                console.error('Word generation error:', error);
                showStatus('ડૉક્યુમેન્ટ જનરેટ કરવામાં ભૂલ', 'error', previewStatus);
            } finally {
                const button = document.getElementById('generate-word');
                button.innerHTML = '<i class="fas fa-file-word"></i> Word જનરેટ કરો';
                button.disabled = false;
            }
        }

        // Clear form
        function clearForm() {
            if (confirm('શું તમે ખરેખર ફોર્મ સાફ કરવા માંગો છો? આ ક્રિયા પાછી લઈ શકાશે નહીં.')) {
                form.reset();
                formData = {};
                localStorage.removeItem('policeFormData');
                updatePreview();
                showStatus('ફોર્મ સાફ કરવામાં આવ્યો છે', 'success', saveStatus);
            }
        }

        // Print preview
        function printPreview() {
            const printContent = preview.innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>ગુજરાત પોલીસ ડૉક્યુમેન્ટ</title>
                    <style>
                        body { font-family: 'Noto Sans Gujarati', serif; padding: 40px; line-height: 1.8; }
                        .document-header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #000; padding-bottom: 20px; }
                        .document-header h1 { font-size: 2.2rem; margin-bottom: 10px; }
                        .section-title { font-size: 1.4rem; font-weight: bold; margin: 25px 0 15px; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
                        .form-field-row { display: flex; margin-bottom: 8px; }
                        .field-label { min-width: 250px; font-weight: bold; }
                        .field-value { flex: 1; padding-left: 10px; border-bottom: 1px dotted #aaa; }
                        .signature-line { margin-top: 100px; border-top: 1px solid #000; width: 300px; margin-left: auto; text-align: center; padding-top: 5px; }
                        @media print { body { -webkit-print-color-adjust: exact; } @page { margin: 20mm; } }
                    </style>
                </head>
                <body>
                    ${printContent}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.focus();
            
            setTimeout(() => {
                printWindow.print();
            }, 500);
        }

        // Show status message
        function showStatus(message, type, element) {
            if (!element) return;
            
            element.textContent = message;
            element.className = `status-message status-${type}`;
            element.style.display = 'block';
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                element.style.display = 'none';
            }, 3000);
        }
    </script>
</body>
</html>